<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG Map Viewer with Distance Measurement</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        #map {
            height: 90vh;
            width: 100%;
        }
        #distance-info {
            margin-top: 10px;
            font-weight: bold;
        }
        #reset-button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="distance-info">Distance: 0 meters</div>
    <button id="reset-button">Reset Measurement</button>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // Map configuration
        const imageUrl = '/maps/miramar.jpg';  // Path to the map image
        const imageWidth = 1920;  // Image width in pixels
        const imageHeight = 1080; // Image height in pixels

        // Calibrate the scale: Assume each 100-meter square is 89 pixels in length
        const pixelsPerSquare = 89;  // Replace with actual measured pixel length of a 100-meter square
        const realSquareDistance = 100;  // Real-world distance represented by each small square (100 meters)
        const pixelsPerMeter = pixelsPerSquare / realSquareDistance; // Calculate pixels per meter

        // Initialize map
        const map = L.map('map', {
            minZoom: -2,
            maxZoom: 4,
            crs: L.CRS.Simple
        });
        const imageBounds = [[0, 0], [imageHeight, imageWidth]];
        L.imageOverlay(imageUrl, imageBounds).addTo(map);
        map.fitBounds(imageBounds);

        // Variables for tracking points and total distance
        let pointA = null;
        let totalDistance = 0;

        // Function to display a point on the map
        function displayPoint(lat, lng) {
            L.circleMarker([lat, lng], { color: 'red', radius: 3 }).addTo(map);
        }

        // Function to draw line between two points
        function drawLine(pointA, pointB) {
            if (pointA && pointB) {
                L.polyline([pointA, pointB], { color: 'blue' }).addTo(map);
            }
        }

        // Function to calculate distance between two points in meters
        function calculateDistance(pointA, pointB) {
            const point1 = map.latLngToLayerPoint(pointA);
            const point2 = map.latLngToLayerPoint(pointB);
            const distanceInPixels = point1.distanceTo(point2);
            return distanceInPixels / pixelsPerMeter;  // Convert pixel distance to meters
        }

        // Map click event for measuring distance
        map.on('click', (e) => {
            const clickedPoint = e.latlng;
            displayPoint(clickedPoint.lat, clickedPoint.lng);

            if (!pointA) {
                // Set pointA if it's the first click
                pointA = clickedPoint;
            } else {
                // Calculate distance between pointA and clickedPoint (pointB)
                const distance = calculateDistance(pointA, clickedPoint);
                totalDistance += distance;

                // Draw line and update the distance display
                drawLine(pointA, clickedPoint);
                document.getElementById("distance-info").innerHTML = `Distance: ${totalDistance.toFixed(2)} meters`;

                // Reset pointA for next measurement
                pointA = clickedPoint;
            }
        });

        // Reset button to clear measurements
        document.getElementById('reset-button').addEventListener('click', () => {
            // Clear all layers except the image overlay
            map.eachLayer((layer) => {
                if (layer instanceof L.Polyline || layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });

            // Reset variables
            pointA = null;
            totalDistance = 0;
            document.getElementById("distance-info").innerHTML = `Distance: 0 meters`;
        });
    </script>
</body>
</html>
